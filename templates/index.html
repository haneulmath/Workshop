
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/template-styles.css') }}">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: Arial, sans-serif;
        }
        .hidden {
            display: none;
        }
        #login-section {
            max-width: 400px;
            margin: 100px auto;
            padding: 2rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .movie-card {
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <section id="login-section">
            <h2 class="text-center mb-4">Welcome to Cinemacousas</h2>
            <form id="login-form">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" value="default_user" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" value="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
            </form>
            <div class="text-center mt-3">
                <small class="text-muted">
                    <a href="/admin" class="text-decoration-none">Interface d'administration</a>
                </small>
            </div>
        </section>

        <section id="reservation-section" class="hidden">
            <h1 class="my-4 text-center">Réservation de Cinéma</h1>

            <!-- Étape 1: Sélection du film -->
            <div id="movie-selection">
                <h3 class="mb-3">Choisissez votre film</h3>
                <div class="row" id="movies-container">
                    <!-- Les films seront chargés dynamiquement -->
                </div>
            </div>

            <!-- Étape 2: Sélection de la séance -->
            <div id="session-selection" class="hidden mt-5">
                <button id="back-to-movies" class="btn btn-secondary mb-3">← Retour aux films</button>
                <h3 id="selected-movie-title"></h3>
                <p class="text-muted">Sélectionnez une séance :</p>
                <div class="row" id="sessions-container">
                    <!-- Les séances seront chargées dynamiquement -->
                </div>
            </div>

            <!-- Étape 3: Sélection des sièges -->
            <div id="seat-selection" class="hidden mt-5">
                <button id="back-to-sessions" class="btn btn-secondary mb-3">← Retour aux séances</button>
                <h3 id="selected-session-title"></h3>
                <div class="screen">ÉCRAN</div>
                <div class="seat-grid" id="seat-grid"></div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-seat normal-legend"></div> Normal</div>
                    <div class="legend-item"><div class="legend-seat pmr-legend"></div> PMR</div>
                    <div class="legend-item"><div class="legend-seat stair-legend"></div> Escalier</div>
                    <div class="legend-item"><div class="legend-seat empty-legend"></div> Vide</div>
                    <div class="legend-item"><div class="legend-seat selected-legend"></div> Sélectionné</div>
                    <div class="legend-item"><div class="legend-seat occupied-legend"></div> Occupé</div>
                </div>

                <div id="order-summary" class="mt-4">
                    <h4>Résumé de commande</h4>
                    <ul id="spectator-list" class="list-group">
                        </ul>
                    <button id="validate-order" class="btn btn-success mt-3">Valider la commande</button>
                </div>
            </div>
        </section>
    </div>

    <div class="modal fade" id="spectator-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Spectator Information - Siège <span id="seat-label-display"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="spectator-form">
                        <input type="hidden" id="seat-id-input">
                        <div class="mb-3">
                            <label for="first-name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="first-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="last-name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="last-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="age" class="form-label">Age</label>
                            <input type="number" class="form-control" id="age" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Spectator</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loginSection = document.getElementById('login-section');
            const reservationSection = document.getElementById('reservation-section');
            const loginForm = document.getElementById('login-form');

            const movieSelection = document.getElementById('movie-selection');
            const sessionSelection = document.getElementById('session-selection');
            const seatSelection = document.getElementById('seat-selection');
            
            const moviesContainer = document.getElementById('movies-container');
            const sessionsContainer = document.getElementById('sessions-container');
            const selectedMovieTitle = document.getElementById('selected-movie-title');
            const selectedSessionTitle = document.getElementById('selected-session-title');
            
            const backToMoviesBtn = document.getElementById('back-to-movies');
            const backToSessionsBtn = document.getElementById('back-to-sessions');

            const seatGrid = document.getElementById('seat-grid');
            const spectatorList = document.getElementById('spectator-list');
            const validateOrderBtn = document.getElementById('validate-order');

            const spectatorModal = new bootstrap.Modal(document.getElementById('spectator-modal'));
            const spectatorForm = document.getElementById('spectator-form');
            const seatIdInput = document.getElementById('seat-id-input');

            let selectedSeats = {}; // Object to store spectator info by seatId
            let currentMovie = null;
            let currentSeance = null;

            // --- LOGIN LOGIC ---
            loginForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                try {
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        loginSection.classList.add('hidden');
                        reservationSection.classList.remove('hidden');
                        await loadMovies();
                    } else {
                        alert(result.message || 'Erreur de connexion');
                    }
                } catch (error) {
                    console.error('Erreur lors de la connexion:', error);
                    alert('Erreur de connexion au serveur');
                }
            });

            // --- LOAD MOVIES ---
            async function loadMovies() {
                try {
                    const response = await fetch('/api/movies');
                    const movies = await response.json();
                    
                    moviesContainer.innerHTML = '';
                    
                    if (movies.length === 0) {
                        moviesContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">Aucun film disponible</div></div>';
                        return;
                    }

                    movies.forEach(movie => {
                        const movieCard = createMovieCard(movie);
                        moviesContainer.appendChild(movieCard);
                    });
                } catch (error) {
                    console.error('Erreur lors du chargement des films:', error);
                    moviesContainer.innerHTML = '<div class="col-12"><div class="alert alert-danger">Erreur lors du chargement</div></div>';
                }
            }

            function createMovieCard(movie) {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-3';
                
                col.innerHTML = `
                    <div class="card movie-card" data-movie-id="${movie.id}">
                        <img src="https://via.placeholder.com/300x450/6c757d/ffffff?text=${encodeURIComponent(movie.name)}" class="card-img-top" alt="${movie.name}">
                        <div class="card-body">
                            <h5 class="card-title">${movie.name}</h5>
                            <p class="card-text">
                                Durée: ${movie.duration} minutes
                            </p>
                            <button class="btn btn-primary">Voir les séances</button>
                        </div>
                    </div>
                `;
                
                col.querySelector('.movie-card').addEventListener('click', () => {
                    selectMovie(movie);
                });
                
                return col;
            }

            async function selectMovie(movie) {
                currentMovie = movie;
                selectedMovieTitle.textContent = movie.name;
                movieSelection.classList.add('hidden');
                sessionSelection.classList.remove('hidden');
                
                await loadSessions(movie.id);
            }

            // --- LOAD SESSIONS ---
            async function loadSessions(movieId) {
                try {
                    const response = await fetch(`/api/movie/${movieId}/seances`);
                    const sessions = await response.json();
                    
                    sessionsContainer.innerHTML = '';
                    
                    if (sessions.length === 0) {
                        sessionsContainer.innerHTML = '<div class="col-12"><div class="alert alert-info">Aucune séance programmée pour ce film</div></div>';
                        return;
                    }

                    // Grouper les séances par date
                    const sessionsByDate = sessions.reduce((acc, session) => {
                        if (!acc[session.date]) {
                            acc[session.date] = [];
                        }
                        acc[session.date].push(session);
                        return acc;
                    }, {});

                    Object.keys(sessionsByDate).sort().forEach(date => {
                        const dateContainer = document.createElement('div');
                        dateContainer.className = 'col-12 mb-4';
                        
                        const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('fr-FR', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });

                        dateContainer.innerHTML = `
                            <h4 class="mb-3">${formattedDate}</h4>
                            <div class="row" id="sessions-${date}"></div>
                        `;
                        
                        sessionsContainer.appendChild(dateContainer);
                        
                        const daySessionsContainer = document.getElementById(`sessions-${date}`);
                        sessionsByDate[date].forEach(session => {
                            const sessionCard = createSessionCard(session);
                            daySessionsContainer.appendChild(sessionCard);
                        });
                    });
                } catch (error) {
                    console.error('Erreur lors du chargement des séances:', error);
                    sessionsContainer.innerHTML = '<div class="col-12"><div class="alert alert-danger">Erreur lors du chargement</div></div>';
                }
            }

            function createSessionCard(session) {
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-3';
                
                col.innerHTML = `
                    <div class="card session-card" data-session-id="${session.id}">
                        <div class="card-body text-center">
                            <h6 class="card-title">${session.time}</h6>
                            <p class="card-text">
                                Salle: ${session.room}<br>
                                Prix: ${session.price}€
                            </p>
                            <button class="btn btn-outline-primary btn-sm">Sélectionner</button>
                        </div>
                    </div>
                `;
                
                col.querySelector('.session-card').addEventListener('click', () => {
                    selectSession(session);
                });
                
                return col;
            }

            async function selectSession(session) {
                currentSeance = session;
                const sessionDate = new Date(session.date + 'T00:00:00').toLocaleDateString('fr-FR');
                selectedSessionTitle.textContent = `${currentMovie.name} - ${sessionDate} à ${session.time} - Salle ${session.room}`;
                sessionSelection.classList.add('hidden');
                seatSelection.classList.remove('hidden');
                
                await loadSeats(session.id);
                updateOrderSummary();
            }

            // Navigation buttons
            backToMoviesBtn.addEventListener('click', function() {
                sessionSelection.classList.add('hidden');
                movieSelection.classList.remove('hidden');
                currentMovie = null;
            });

            backToSessionsBtn.addEventListener('click', function() {
                seatSelection.classList.add('hidden');
                sessionSelection.classList.remove('hidden');
                currentSeance = null;
                selectedSeats = {};
                updateOrderSummary();
            });

            // --- SEAT LOADING ---
            async function loadSeats(seanceId) {
                try {
                    const response = await fetch(`/api/seance/${seanceId}/seats`);
                    const data = await response.json();
                    
                    if (data.error) {
                        alert('Erreur: ' + data.error);
                        return;
                    }
                    
                    generateSeatGrid(data);
                } catch (error) {
                    console.error('Erreur lors du chargement des sièges:', error);
                    alert('Erreur lors du chargement des sièges');
                }
            }

            function generateSeatGrid(data) {
                const { room, grid } = data;
                seatGrid.innerHTML = '';
                
                // Définir le CSS Grid basé sur les dimensions de la salle
                seatGrid.style.gridTemplateColumns = `auto repeat(${room.nb_columns}, 1fr)`;
                
                // Ajouter un spacer vide pour l'alignement
                const headerSpacer = document.createElement('div');
                seatGrid.appendChild(headerSpacer);
                
                // En-têtes de colonnes (1, 2, 3, ...)
                for (let colIndex = 1; colIndex <= room.nb_columns; colIndex++) {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'column-header';
                    headerDiv.textContent = colIndex;
                    headerDiv.style.fontWeight = 'bold';
                    headerDiv.style.textAlign = 'center';
                    headerDiv.style.padding = '5px';
                    headerDiv.style.fontSize = '12px';
                    headerDiv.style.color = '#495057';
                    seatGrid.appendChild(headerDiv);
                }
                
                // Générer les rangées (A, B, C, ...)
                for (let rowIndex = 1; rowIndex <= room.nb_rows; rowIndex++) {
                    const rowLetter = String.fromCharCode(64 + rowIndex);
                    
                    // Label de la rangée
                    const rowLabel = document.createElement('div');
                    rowLabel.className = 'row-label';
                    rowLabel.textContent = rowLetter;
                    rowLabel.style.fontWeight = 'bold';
                    rowLabel.style.textAlign = 'center';
                    rowLabel.style.padding = '5px';
                    seatGrid.appendChild(rowLabel);
                    
                    // Sièges de la rangée
                    for (let colIndex = 1; colIndex <= room.nb_columns; colIndex++) {
                        const seatElement = document.createElement('div');
                        seatElement.classList.add('seat');
                        // Supprimer l'affichage du numéro
                        // seatElement.textContent = colIndex;
                        
                        // Récupérer les données du siège
                        const seatData = grid[rowLetter] && grid[rowLetter][colIndex];
                        if (seatData) {
                            seatElement.dataset.id = seatData.id;
                            seatElement.dataset.label = `${rowLetter}${colIndex}`;
                            seatElement.dataset.type = seatData.type;
                            
                            // Ajouter la classe CSS selon le type de siège
                            seatElement.classList.add(seatData.type);
                            
                            // Gérer les états
                            if (seatData.occupied) {
                                seatElement.classList.add('occupied');
                            }
                            
                            // Les escaliers et espaces vides ne sont pas cliquables
                            if (seatData.type === 'stair' || seatData.type === 'empty') {
                                seatElement.style.pointerEvents = 'none';
                            }
                        }
                        
                        seatGrid.appendChild(seatElement);
                    }
                }
            }

            seatGrid.addEventListener('click', function(event) {
                const seat = event.target;
                const seatType = seat.dataset.type;
                
                // Vérifier que le siège est sélectionnable
                if (seat.classList.contains('seat') && 
                    !seat.classList.contains('occupied') && 
                    seatType !== 'stair' && 
                    seatType !== 'empty') {
                    
                    const seatId = seat.dataset.id;
                    const seatLabel = seat.dataset.label;
                    
                    if (seat.classList.contains('selected')) {
                        // Deselect seat
                        delete selectedSeats[seatId];
                        seat.classList.remove('selected');
                        updateOrderSummary();
                    } else {
                        // Select seat - open modal
                        seatIdInput.value = seatId;
                        document.getElementById('seat-label-display').textContent = seatLabel;
                        spectatorForm.reset(); // Clear previous inputs
                        spectatorModal.show();
                    }
                }
            });

            // --- SPECTATOR MODAL LOGIC ---
            spectatorForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const seatId = seatIdInput.value;
                const firstName = document.getElementById('first-name').value;
                const lastName = document.getElementById('last-name').value;
                const age = document.getElementById('age').value;
                
                if(firstName && lastName && age) {
                    selectedSeats[seatId] = { 
                        firstname: firstName, 
                        lastname: lastName, 
                        age: parseInt(age),
                        seat_id: parseInt(seatId)
                    };
                    const seatElement = document.querySelector(`.seat[data-id="${seatId}"]`);
                    seatElement.classList.add('selected');
                    spectatorModal.hide();
                    updateOrderSummary();
                } else {
                    alert('Please fill all fields.');
                }
            });

            // --- ORDER SUMMARY LOGIC ---
            function updateOrderSummary() {
                spectatorList.innerHTML = '';
                let hasSelections = false;
                for (const seatId in selectedSeats) {
                    hasSelections = true;
                    const spectator = selectedSeats[seatId];
                    const seatLabel = document.querySelector(`.seat[data-id="${seatId}"]`).dataset.label;
                    const li = document.createElement('li');
                    li.classList.add('list-group-item');
                    li.textContent = `Siège ${seatLabel}: ${spectator.firstname} ${spectator.lastname} (Âge: ${spectator.age})`;
                    spectatorList.appendChild(li);
                }
                if (!hasSelections) {
                     const li = document.createElement('li');
                    li.classList.add('list-group-item', 'text-muted');
                    li.textContent = 'Aucun siège sélectionné.';
                    spectatorList.appendChild(li);
                }
            }
            
            // --- VALIDATE ORDER LOGIC ---
            validateOrderBtn.addEventListener('click', async function() {
                if (Object.keys(selectedSeats).length === 0) {
                    alert('Veuillez sélectionner au moins un siège.');
                    return;
                }

                const spectators = Object.values(selectedSeats);
                
                try {
                    const response = await fetch('/api/booking', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            seance_id: currentSeance.id,
                            spectators: spectators
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert(result.message);
                        // Reset state
                        seatSelection.classList.add('hidden');
                        movieSelection.classList.remove('hidden');
                        selectedSeats = {};
                        currentSeance = null;
                        await loadTodaysSeances(); // Reload to update seat availability
                    } else {
                        alert('Erreur: ' + result.message);
                    }
                } catch (error) {
                    console.error('Erreur lors de la validation:', error);
                    alert('Erreur lors de la validation de la commande');
                }
            });

        });
    </script>
</body>
</html>