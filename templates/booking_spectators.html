{% extends "base.html" %}

{% block title %}Informations des spectateurs - {{ showing.movie }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- En-tête de la séance -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h2 class="card-title">{{ showing.movie }}</h2>
                            <p class="text-muted mb-1">
                                <i class="fas fa-calendar"></i> {{ showing.date.strftime('%d/%m/%Y') }}
                                <i class="fas fa-clock ms-3"></i> {{ showing.time }}
                            </p>
                            <p class="text-muted mb-0">
                                <i class="fas fa-door-open"></i> Salle {{ showing.room }}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="selected-seats-info">
                                <span class="text-muted">Places sélectionnées:</span>
                                <div class="mt-1">
                                    {% for seat in selected_seats %}
                                        <span class="badge bg-primary me-1">{{ seat.seat_row }}{{ seat.seat_column }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulaire des informations des spectateurs -->
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-users"></i> Informations des spectateurs
                    </h4>
                    <small class="text-muted">Veuillez renseigner les informations pour chaque spectateur</small>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('process_spectators_info') }}" id="spectators-form">
                        <input type="hidden" name="showing_id" value="{{ showing.id }}">
                        <input type="hidden" name="selected_seats" value="{{ selected_seats_json }}">
                        
                        {% for seat in selected_seats %}
                        <div class="spectator-info mb-4 p-3 border rounded">
                            <h5 class="mb-3">
                                <i class="fas fa-chair"></i> 
                                Place {{ seat.seat_row }}{{ seat.seat_column }}
                                {% if seat.type == 'pmr' %}
                                    <span class="badge bg-warning text-dark">PMR</span>
                                {% endif %}
                            </h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="first_name_{{ loop.index0 }}" class="form-label">Prénom *</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="first_name_{{ loop.index0 }}" 
                                           name="spectators[{{ loop.index0 }}][first_name]" 
                                           required>
                                </div>
                                <div class="col-md-4">
                                    <label for="last_name_{{ loop.index0 }}" class="form-label">Nom *</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="last_name_{{ loop.index0 }}" 
                                           name="spectators[{{ loop.index0 }}][last_name]" 
                                           required>
                                </div>
                                <div class="col-md-4">
                                    <label for="age_{{ loop.index0 }}" class="form-label">Âge *</label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="age_{{ loop.index0 }}" 
                                           name="spectators[{{ loop.index0 }}][age]" 
                                           min="1" 
                                           max="120" 
                                           required
                                           onchange="updatePricing()">
                                    <input type="hidden" 
                                           name="spectators[{{ loop.index0 }}][seat_id]" 
                                           value="{{ seat.id }}">
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Résumé des prix -->
                        <div class="pricing-summary card mb-4" style="background-color: #f8f9fa;">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-calculator"></i> Récapitulatif des prix
                                </h5>
                                <div id="pricing-details">
                                    <!-- Les détails de prix seront générés dynamiquement -->
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong class="fs-5">Total:</strong>
                                    <strong class="fs-4 text-primary" id="total-amount">0.00€</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('showing_seats', showing_id=showing.id) }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Retour à la sélection
                            </a>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-check"></i> Confirmer les informations
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.spectator-info {
    background-color: #f8f9fa;
}

.pricing-summary {
    border: 2px solid #28a745;
}

.pricing-line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
}

.age-category {
    font-size: 0.9em;
    color: #6c757d;
}

@media (max-width: 768px) {
    .spectator-info .row {
        gap: 15px;
    }
    
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 15px;
    }
    
    .btn {
        width: 100%;
    }
}
</style>

<script>
// Prix de base et règles de tarification
const basePrices = {
    normal: {{ showing.price }},
    pmr: {{ showing.price }}
};

// Règles de tarification par âge
const ageRules = [
    { minAge: 0, maxAge: 12, discount: 0.5, label: "Enfant (-12 ans)" },
    { minAge: 13, maxAge: 17, discount: 0.7, label: "Jeune (13-17 ans)" },
    { minAge: 18, maxAge: 25, discount: 0.8, label: "Étudiant (18-25 ans)" },
    { minAge: 26, maxAge: 64, discount: 1.0, label: "Adulte" },
    { minAge: 65, maxAge: 120, discount: 0.6, label: "Senior (+65 ans)" }
];

const selectedSeats = {{ selected_seats | tojson }};

document.addEventListener('DOMContentLoaded', function() {
    updatePricing();
});

function updatePricing() {
    const pricingDetails = document.getElementById('pricing-details');
    const totalAmount = document.getElementById('total-amount');
    let total = 0;
    
    pricingDetails.innerHTML = '';
    
    selectedSeats.forEach((seat, index) => {
        const ageInput = document.getElementById(`age_${index}`);
        const age = parseInt(ageInput?.value) || 0;
        
        let price = 0;
        let categoryLabel = "Âge non renseigné";
        
        if (age > 0) {
            const rule = ageRules.find(r => age >= r.minAge && age <= r.maxAge);
            if (rule) {
                const basePrice = basePrices[seat.type] || basePrices.normal;
                price = basePrice * rule.discount;
                categoryLabel = rule.label;
            }
        }
        
        const pricingLine = document.createElement('div');
        pricingLine.className = 'pricing-line';
        pricingLine.innerHTML = `
            <div>
                <strong>Place ${seat.seat_row}${seat.seat_column}</strong>
                ${seat.type === 'pmr' ? '<span class="badge bg-warning text-dark ms-1">PMR</span>' : ''}
                <div class="age-category">${categoryLabel}</div>
            </div>
            <div class="price">
                <strong>${price.toFixed(2)}€</strong>
            </div>
        `;
        
        pricingDetails.appendChild(pricingLine);
        total += price;
    });
    
    totalAmount.textContent = total.toFixed(2) + '€';
}

// Validation du formulaire
document.getElementById('spectators-form').addEventListener('submit', function(e) {
    const requiredFields = this.querySelectorAll('input[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            isValid = false;
            field.classList.add('is-invalid');
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        e.preventDefault();
        alert('Veuillez remplir tous les champs obligatoires.');
    }
});
</script>
{% endblock %}
